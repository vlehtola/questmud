/* vuln shadow. lower natural resistances. query_resists are affected. //Celtron */

#define MASTERY_D "/daemons/mastery_d"

object user;
int duration, effect, pref;

query_resists(string dam_type) {
  int percent;
  if(dam_type != pref) return user->query_resists(dam_type);
  percent = user->query_resists(dam_type);
  /* victim takes up to 2.5-3 times the normal damage (+150-200%) */
  percent = 100 - ( (100 - percent) * (100+effect)/100 );
  if(percent < -20) percent = (percent+20) / 2 - 20;
  return percent;
}

start(object ob, int bonus, string type, object caster) {
  int mastery, mast;
  string skill;
  user = ob;
  if(type == "sol") {
    write("Nothing happens.\n");
    destruct(this_object());
    return 1;
  }
  if(user->query_vulnerability_count() >= 2 ) {
    write("That would harm previous vulnerabilities.\n");
    destruct(this_object());
    return 1;
  }
  shadow(user, 1);
  pref = (string)"/guilds/obj/spellfun"->get_skill_num(type);
  pref = pref[5..strlen(pref)];

  tell_object(user, "Your feel vulnerable!\n");
  tell_room(environment(user), user->short()+" seems more vulnerable to "+pref+"!\n", ({ user, }) );

  skill = call_other("/guilds/spell_obj/protection", "get_mastery", "cast " + pref);
  if(skill) mastery = this_player()->query_skills(skill);
  mastery += this_player()->query_skills("enhance weakness");

  mast = call_other("/guilds/spell_obj/protection","mastery","cast "+pref,user);
  mast += call_other(MASTERY_D,"mastery","Knowledge of weaknesses",this_player(),user);

  /* ~1min +  80s + 80s = 1min - 4,5min */
  duration = bonus/5 + mastery;
  duration += mast*2;
  /* 30 + 160/2.5 = 104, maxx 110% */
  effect = bonus/10 + mastery*2/5;
  effect -= effect/4;
  effect += mast/6;
  if(this_player()->query_wiz())
    write("Duration: "+duration+" Effect: -"+effect+"% (bonus:"+bonus+" mastery:"+mastery+"\n");
  call_out("end_vulnerability", duration);

  //Cast ice causes cold damage, not ice, but skills and masteries are ice! --Rag 26.11.2003
  if(pref == "ice") pref = "cold";

}

query_vulnerability(string type) {
  if(type) {
    if(pref == type) return effect;
    return 0;
  }
  return this_object();
}

query_vulnerability_count() {
  return (user->query_vulnerability_count()+1);
}

end_vulnerability() {
  object old_vuln;
  /* uusi vulni shadowaa vanhan end_vulnia, joten kun vanhan call out tulee ensin se
     pitaa ohjata uudesta vanhaan. jos vanhempia vulneja ei ole, poistaa itsensa.
        //Celtron
  */
  old_vuln = user->query_vulnerability();
  if(old_vuln) {
    old_vuln->end_vulnerability();
    return;
  }     
  tell_object(user, "You feel more resistant.\n");
  tell_room(environment(user), user->short()+" seems more resistant.\n", ({ user, }) );
  destruct(this_object());
}
